scripts ディレクトリにおける処理の学術的記述

本稿では、本研究で用いた前処理および行動データ解析パイプラインの方法論を、`scripts` ディレクトリに実装された範囲に基づき記述する。指示に従い、`first_level_analysis/` とシェルスクリプト（.sh）は対象外とし、コード断片や実行コマンドの提示は避け、方法の要旨に焦点を当てる。

## 要旨

本研究では、(i) fMRI データの前処理を半自動化し、一時領域を用いた安全なファイル操作、平滑化および可視化を含む処理ラインを確立した。さらに、(ii) 食品画像の属性情報と被験者評定を統合し、画像レベルおよび試行レベルの回帰的枠組みにより嗜好関連評定の予測と説明を行った。画像レベルでは正則化回帰および非線形アンサンブル、参照として通常最小二乗（OLS）を用い、試行レベルでは参加者をランダム効果とする混合効果線形モデル（MixedLM）を適用した。いずれも欠損値処理と標準化を含む前処理を行い、推定結果（係数、適合度指標）を文書化した。

## 1. 背景と目的

食品画像に対する主観評定（例：快・不快、欲求）の個人差および画像属性依存性を定量化することは、食行動の神経基盤の理解に資する。これに向け、本研究では fMRI 前処理の実務負荷を軽減しつつ再現性の高い行動データ解析を整備することを目的とした。前処理は fMRIprep 出力を前提に平滑化・可視化までを一貫化し、行動データ解析は画像メタ情報と試行評定を結合した階層的モデリングを含む二層の枠組みを構築した。

## 2. データ

2.1 fMRI データ

fMRIprep から得られる前処理済み BOLD 画像（標準空間、`.nii.gz`）を入力とした。想定された収集構成は、被験者 1–8、各被験者 1–3 セッション、各セッション 4 ランである（設定可能）。

2.2 行動・画像属性データ

画像属性データは、食品画像ごとのメタ情報および規範的評定（例：`Valence_omnivore_Male`）を含む表形式データを用いた。試行レベルの評定データは、各参加者のトライアルごとの質問項目・評定値・反応時間（例：`RT (rel)`）等を含む。両者は画像番号（`Image_No`）により連結し、必要に応じて特定の質問項目（例：「欲しいですか？」）で抽出した。

## 3. 方法：fMRI 前処理

前処理は MATLAB 環境で実装し、以下の段階から成る。

- 入力探索と検証：想定されるパス規約に基づき、被験者・セッション・ランの全組合せについて BOLD 画像の存在を走査し、欠落を一覧化して報告した。
- 展開：圧縮形式（`.nii.gz`）を一時ワークスペースに展開し、後続処理の入出力を同領域に集約した。
- 平滑化：各 BOLD 画像に対し等方ガウシアンカーネルによる空間平滑化を実施した。デフォルトのフル幅半値（FWHM）は [6, 6, 6] mm とした。
- 配置：平滑化結果（先頭が s のファイル命名）を元の入力ディレクトリへ回収し、解析資産と同居させた。
- 可視化：代表スライスの PNG を生成し、診断的可視化を可能とした。
- 終了処理：一時ワークスペースを削除し、ファイル残渣の抑制とセキュアな資源解放を行った。

本系は一時領域を介したステージングにより、原本の破損回避と可搬性の高い運用を意図している。被験者・セッション・ランの範囲、および FWHM はパラメタとして変更可能である。

## 4. 方法：行動データ解析

4.1 特徴量の構成

画像レベルの解析では、画像属性表の数値列から識別子列や目的変数を除外して説明変数集合を構成した（選択肢として「包括的特徴」または「栄養中心特徴」）。後者では栄養関連量（例：タンパク質・脂質・炭水化物・熱量など）や色特性などを優先的に取り込む。非数値カテゴリーはダミー変数化により表現した。

試行レベルの解析では、画像由来の特徴に加え、試行由来の特徴（例：反応時間 `RT (rel)`）を併合した。RGB が存在する場合は多重共線性の低減のため、次の単純平均を導入した：`color_mean = (R + G + B) / 3`。

4.2 前処理

欠損値は中央値代入により処理し、説明変数は標準化した。試行レベルでは、画像由来の欠損は画像集合の中央値、試行由来の欠損は試行集合の中央値で補完した。

4.3 モデル化

- 画像レベル：正則化線形回帰（Ridge）およびランダムフォレスト回帰（非線形アンサンブル）を主モデルとし、参照として通常最小二乗（OLS）を適用した。線形モデルの形式は「y = Xβ + ε」と表される。
- 試行レベル：参加者をランダム効果とする混合効果線形モデル（MixedLM）を採用し、次のように定式化した（i は試行、j は参加者）：

  Rating_ij = β0 + x_ij^T β + u_j + ε_ij,

  ただし u_j ~ N(0, σ_u^2), ε_ij ~ N(0, σ^2)。本構成では参加者ごとの切片変動を許容する。

4.4 評価指標と記録

予測性能の指標として平均二乗誤差（MSE）、決定係数（R^2）、および観測値と予測値のピアソン相関を算出した。線形モデルについては係数推定値と情報量規準（AIC/BIC）を報告可能な形で保存した。混合効果モデルでは適合後の固定効果サマリおよび残差に基づく指標を併せて文書化した。

#### 4.5 結果と成果物（出力ファイル・解釈）
##### . 予測性能指標

以下は `mixedlm_metrics.json` に基づく。

| 指標      | 値    |
| --------- | ----- |
| MSE       | 1.260 |
| RMSE      | 1.123 |
| R^2       | 0.148 |
| Pearson r | 0.385 |
| n_obs     | 9036  |

備考: 値は四捨五入表示（3 桁）

###### 固定効果推定（係数表）

出典: `mixedlm_summary.txt`。括弧内は 95% CI。

| 変数名                                 | 係数 (SE)      | z       | p 値   | 95% CI           |
| -------------------------------------- | -------------- | ------- | ------ | ---------------- |
| 定数項 (const)                         | 2.527 (0.111)  | 22.800  | <0.001 | [2.310, 2.745]   |
| grams_total                            | 0.039 (0.011)  | 3.543   | <0.001 | [0.018, 0.061]   |
| protein_100g                           | 0.074 (0.022)  | 3.323   | 0.001  | [0.030, 0.117]   |
| fat_100g                               | 0.040 (0.077)  | 0.516   | 0.606  | [-0.111, 0.191]  |
| carbs_100g                             | -0.015 (0.063) | -0.239  | 0.811  | [-0.140, 0.109]  |
| kcal_100g                              | -0.103 (0.116) | -0.891  | 0.373  | [-0.331, 0.124]  |
| taste:1=sweet 2=tasty                  | -0.224 (0.013) | -16.581 | <0.001 | [-0.250, -0.197] |
| food: 1=whole foods, 2=processed foods | 0.213 (0.015)  | 14.212  | <0.001 | [0.183, 0.242]   |
| color_mean                             | -0.004 (0.011) | -0.405  | 0.685  | [-0.026, 0.017]  |
| RT (rel)                               | -0.366 (0.011) | -32.877 | <0.001 | [-0.388, -0.344] |
| trial_index                            | 0.007 (0.015)  | 0.447   | 0.655  | [-0.023, 0.036]  |

- ランダム効果（分散成分）: const Var = 0.195, trial_index Var = 0.001, const×trial_index Cov = 0.001
- 残差分散（Scale）: 1.0645

注記:
- taste と food の水準符号化はテキストのラベルに従う（summary 出力由来）。
- p 値 0.000 と表示されたものは p < 0.001 と解釈。

## 4. 簡易解釈（要点）

- 試行時間指標 RT (rel) は有意な負の関連（係数=-0.367, p<0.001）：反応が遅いほど評定が低い傾向。
- 加工食品（food=processed）は正の関連（0.213, p<0.001）。
- taste（sweet→tasty）ラベルは負の関連（-0.224, p<0.001）。
- 栄養関連では protein_100g と grams_total が正の関連で有意（それぞれ 0.073, 0.040）。fat, carbs, kcal は有意でない。
- 参加者間のベースライン差（ランダム切片）の分散は 0.195。



## 5. 方法：fMRI 統計解析（`scripts/suzuki`）

本節では、`scripts/suzuki` に実装された SPM を用いた一次（被験者内）および二次（群レベル）GLM の手続きを要約する。

5.1 一次レベル GLM（被験者内）

- 対象データ：前処理済みかつ平滑化済み BOLD（`s` 接頭辞ファイル）を入力とし、各被験者（例：001–008）、各セッション（例：01–03）、各ラン（例：1–4）を包括する設計を想定する。
- 設計仕様：
  - HRF は標準カノニカル（時間・分散微分なし）
  - 高域通過フィルタは 128 s
  - 時系列相関は AR(1)
  - マスキングしきいは MIP しきい値 0.75（相対的閾値）
  - マイクロタイミングは既定の高分解能設定（例：fmri_t=60, fmri_t0=30）
  - 6 つの剛体運動パラメータ（trans_x/y/z, rot_x/y/z）を外的共変量として導入
- 刺激系列：各ランの条件情報はあらかじめ構成された設計行列入力（multi 形式）から読み込み、各ランを独立セッションとして指定する。
- 推定とコントラスト：古典的最小二乗により推定後、条件名に合致する列を全セッション横断で収集し（例：ImagexValue）、対応する t コントラストを定義する。既存コントラストは必要に応じて置換する。
- 可視化：SPM の canonical T1（single_subj_T1）上に結果を重畳し、FWE 0.05 で閾値化した図版を保存する。

#### モデルの基本形（連続時間）

各ボクセルの BOLD 信号 y を、HRF 畳み込み済みのイベント列の線形和で表す。セッション（=ラン） r ごとに、

```
y_r(t) = beta_0,r
         + beta_Img,r * (h * u_Image)(t)
         + beta_Val,r * (h * (u_Image * m_Value))(t)
         + beta_Lum,r * (h * (u_Image * m_Luminance))(t)
         + beta_Q,r   * (h * u_Question)(t)
         + beta_R,r   * (h * u_Response)(t)
         + beta_F,r   * (h * u_Feedback)(t)
         + beta_Miss,r* (h * u_Miss)(t)        # ミストライアルがある場合のみ
         + M_r(t) * gamma_r
         + epsilon_r(t).
```

- `h`: SPM 標準 HRF（微分なし）。
- `u_Image(t)`: Image 期間（onset=image、duration=question−image）のボックス関数の和。
- `m_Value`: 各試行の主観的評価値（RatingValue）。
- `m_Luminance`: 画像輝度。
- `u_Question(t)`: question から rating までのボックス関数。
- `u_Response(t)`: rating のインパルス（duration = 0）。
- `u_Feedback(t)`: rating から 0.5 秒のボックス関数。
- `u_Miss(t)`: ミストライアル（RatingValue = 0）の image から rating まで。
- `M_r(t)`: 6 つの頭動回帰子（trans_x, trans_y, trans_z, rot_x, rot_y, rot_z）の時系列。
- `gamma_r`: 頭動回帰子の係数ベクトル。
- `epsilon_r(t)`: 残差。高域通過フィルタ（HPF=128 s）を適用し、系列相関は AR(1) でモデル化（共分散 `V_r`）。

計測は `TR = 0.8 s` で離散サンプリングされ、SPM のマイクロタイミング設定（`fmri_t = 60`, `fmri_t0 = 30`）で HRF 畳み込みが行われる。`m_Value` と `m_Luminance` は `u_Image` のパラメトリック変調として乗算される（直交化は OFF）。

#### 行列表現（離散時間）

セッション r ごとの時系列ベクトルを連結すると、

```
y = X beta + epsilon,
epsilon ~ N(0, V).
```

`X` はセッションごとに次の列を持つ（SPM の内部生成順に準拠）。

1. Image 主効果: `(h * u_Image)`
2. Image × Value（1 次）: `(h * (u_Image * m_Value))`
3. Image × Luminance（1 次）: `(h * (u_Image * m_Luminance))`
4. Question 主効果: `(h * u_Question)`
5. Response 主効果: `(h * u_Response)`
6. Feedback 主効果: `(h * u_Feedback)`
7. Miss 主効果（ミスが存在する場合のみ）
8. 6 頭動回帰子
9. セッション定数項（SPM が自動付与）

前処理演算（HPF）と誤差共分散（AR(1)）は推定時に組み込まれる。

#### コントラスト（例：Image × Value）

一次レベルでの主コントラストは「Image × Value（1 次）」の正の効果。各ラン r の該当列に 1 を置き、それ以外 0 としたベクトルを連結し、

```
c_Val^T beta = sum_r beta_Val,r
```

を検定する（`sessrep = 'none'` で全ラン平均の効果）。この一次コントラスト画像を二次レベルに持ち上げ、被験者間の one-sample t 検定で群平均効果を評価する。

#### 各項の意味（要点）

- HRF 畳み込み: 刺激時系列を脳血流応答モデルで平滑化し、BOLD 変化に対応させる。
- パラメトリック変調: 試行ごとに異なる連続値（評価値・輝度）で Image 反応の振幅変動をモデル化。直交化 OFF のため、Value と Luminance は相互に依存せず同時推定（共線性の確認は別途必要）。
- ヌイサンス回帰子: モーション由来の信号を説明し、主効果・変調効果の推定を安定化。
- HPF=128 s と AR(1): 低周波ドリフト除去と系列相関補正により統計的妥当性を担保。
- 拡張の余地: Value^2（非線形）、|Value−中立|（サリエンス）、カテゴリ別の離散条件などを追加可能（pmod や条件 `u(t)` の列を増やす）。


5.2 二次レベル GLM（群レベル）

- 入力：各被験者の一次レベルで得た所与コントラスト画像（con_*.nii）を収集し、最新の解析出力を採用する。
- モデル：一標本 t 検定（one-sample t-test）により群平均効果を評価する。
- 推定・コントラスト：古典的推定後、対象コントラストに対応する群レベル t コントラストを設定する。
- 可視化としきい：FWE 補正 0.05、最小クラスタサイズの基準（例：20 ボクセル）を適用し、結果図版（JPG）を出力する。
- 出力構造：`results/second_level_analysis/<モデル名>/<コントラスト>_<タイムスタンプ>/` に SPM.mat および派生物を体系的に保存する。


5.3 解釈上の注意

- 一次レベル設計は標準 HRF かつ 6 軸運動のみを共変量とするため、生理・スライス等の追加補正は今後の拡張対象となる。
- 群レベルは一標本 t による固定形式であり、共変量（年齢・性別・行動指標）や被験者内コントラストの多重比較制御は別途設計が必要である。
